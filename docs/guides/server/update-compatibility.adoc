<#import "/templates/guide.adoc" as tmpl>
<#import "/templates/kc.adoc" as kc>

<@tmpl.guide
title="Update Compatibility Tool"
summary="Learn how to use this tool before upgrade {project_name}"
preview="true">

// TODO Link to discussion?

The goal of this tool is to assist with modifying a {project_name} deployment, whether upgrading to a new version, enabling/disabling features, or changing configuration.
The outcome will indicate whether a rolling upgrade is possible or if a recreate upgrade is required.

[NOTE]
====
.Rolling Upgrade
In the context of this guide, a rolling upgrade is an upgrade that can be performed with zero downtime for your deployment.
Your {project_name} nodes must be updated one by one; in other words, shut down one of your old deployment nodes and start a new deployment node.
Wait until the new node is operational before proceeding to the next {project_name} node.
====

[NOTE]
====
.Recreate Upgrade
A recreate upgrade is not compatible with zero-downtime and requires downtime to be applied.
Your cluster must be shut down before applying the change.
====

The update compatibility tool involves two steps:

1. Generating the required metadata.
2. Checking the metadata to determine the possible upgrade type.

[WARNING]
====
The tool is under development and may return an incorrect result.

Use with caution and always try to upgrade your deployment in a staged environment first.
====

== Generating the Metadata

To generate the metadata, execute the following command using the same {project_name} version and configuration options:

.Generate and save the metadata from the current deployment.
<@kc.updatecompatibility parameters="metadata --file=/path/to/file.json"/>

This command accepts all options used by the `start` command.
The metadata, in JSON format, is displayed in the console.
The `--file` parameter allows you to save the metadata to a file.
This file is then used by the subsequent command.

[WARNING]
====
Ensure that all configuration options, whether set via environment variables or CLI arguments, are included when running the above command.

Omitting any configuration options will result in incomplete metadata.
====

== Checking the Metadata

This command checks the metadata generated by the previous command and compares it with the current configuration and {project_name} version.
If you are upgrading to a new {project_name} version, this command must be executed with the new version.

.Check the metadata from a previous deployment.
<@kc.updatecompatibility parameters="check --file=/path/to/file.json"/>

[WARNING]
====
* Ensure that all configuration options, whether set via environment variables or CLI arguments, are included when running this command.

* Verify that the correct {project_name} version is used.

Failure to meet these requirements will result in an incorrect outcome.
====

The command will print the result to the console.
For example, if a rolling upgrade is possible, it will display:

.Rolling Upgrade possible message
[source,bash]
----
[OK] Rolling Upgrade is available.
----

Otherwise, the command will indicate that a rolling upgrade is not possible and, optionally, provide details about the incompatibility:

.Rolling Upgrade not possible message
[source,bash]
----
[Versions] Rolling Upgrade is not available. 'infinispan' is incompatible: Old=15.0.0.Final, New=15.0.11.Final #<1>
----
<1> In this example, the Infinispan version `15.0.0.Final` is not compatible with version `15.0.11.Final` and a rolling upgrade is not possible.

*Command exit code*

To aid in the development of your automation and/or DevOps pipelines, the command's exit code can be used to determine the upgrade type:

|===
|Exit Code |Description

m|0
|Rolling Upgrade is possible.

m|1
|Unexpected error occurred (e.g., the metadata file is missing or corrupted).

m|2
|Invalid CLI option.

m|3
|Rolling Upgrade is not possible.
The deployment must be shut down before applying the new configuration.
|===

[WARNING]
====
This feature is under development.
Always test upgrades in a staged environment before implementing them in production.
====

</@tmpl.guide>
